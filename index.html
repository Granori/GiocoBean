<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gioco</title>
    <script src="https://unpkg.com/kaplay@3001/dist/kaplay.js"></script>
</head>
<body>

    <script>

        const larghezza = 1500;
        const altezza = 650;

        const pagina = kaplay ({
            width: larghezza,
            height: altezza,
            background: [135, 206, 235],
        });
        pagina.onKeyPress((key) => {
            debug.log("key: "+key);
        });
        pagina.onKeyPress("f", () => {
            setFullscreen(!isFullscreen());
        });

        pagina.setGravity(1000);
        loadSprite("terra", "./sprites/grass.png");
        loadSprite("acciaio", "./sprites/steel.png");
        loadSprite("trappola", "./sprites/spike.png");

        loadSprite("portale", "./sprites/portal.png");

        loadSprite("bean", "./sprites/bean.png");
        loadSprite("bean2", "./sprites/bean2.png");
        loadSprite("bean3", "./sprites/bean3.png");

        let mappa = [
            "           @",
            "       ######",
            "",
            "     ===   #",
            "                #",
            "                    #",
            "",
            "       =    = =     ==",
            "       ^?",
            "=   =  =?",
            "  = ",
            "?",
            ">3",
            " ?",
            "",
            "<",
            "",
            ">",
            "",
            " ?",
            "^       ^          ^^^^",
            "=   =   =   =    = ####",
            " =   =   ",
            "==========!"
        ]

        pagina.add([
            pagina.rect(10, 5000),
            pagina.pos(-10, 0),
            pagina.area(),
            pagina.body( {isStatic : true })
        ]);
        pagina.add([
            pagina.rect(10, 5000),
            pagina.pos(larghezza, 0),
            pagina.area(),
            pagina.body( {isStatic : true })
        ]);

        function generaMappa(mappa) {
            mappa.reverse();

            let x = 0;
            let y = 0;
            mappa.forEach(riga => {
                if (riga.charAt(riga.length-1) == "!") {
                    riga = riga.slice(0, -1); 
                    while (riga.length <= 24) {
                        if (riga.charAt(riga.length-1) == "=") riga += "=";
                        else if (riga.charAt(riga.length-1) == " ") riga += " ";
                    }
                }

                if (riga.charAt(riga.length-1) == "?") {
                    if (riga.length == 1) riga = "="+riga;
                    riga = riga.slice(0, -1);

                    let trappole = false;
                    while (riga.length <= 24) {
                        if (riga.charAt(riga.length-1) == "=") riga += "  ";
                        else if (riga.charAt(riga.length-1) == " ") {
                            if (!trappole) riga += " =";
                            else riga += " ^";
                        }
                        else if (riga.charAt(riga.length-1) == "^") {
                            riga += "  ";
                            trappole = true;
                        }
                    }
                }

                let vel = false;
                if ((riga.charAt(riga.length-1) == "2" || riga.charAt(riga.length-1) == "3") && (riga.charAt(riga.length-2) == "<" || riga.charAt(riga.length-2) == ">")) {
                    vel = true;
                }
                let raggiunto = false;
                for (let i = 0; i < riga.length; i++) {
                    if (vel && raggiunto) {
                        vel = false;
                        raggiunto = false;
                        continue;
                    }

                    switch (riga.charAt(i)) {
                        case "=":
                            pagina.add([
                                pagina.sprite("terra"),
                                pagina.pos(x, altezza-50-y),
                                pagina.area(),
                                pagina.body( { isStatic: true })
                            ]);
                            break;
                        
                        case "#":
                            pagina.add([
                                pagina.sprite("acciaio"),
                                pagina.pos(x, altezza-50-y),
                                pagina.area(),
                                pagina.body( { isStatic: true })
                            ]);
                            break;

                        case "^":
                            pagina.add([
                                pagina.sprite("trappola"),
                                pagina.pos(x, altezza-y),
                                pagina.area(),
                                pagina.body( { isStatic: true }),
                                "trappola"
                            ]);
                            break;

                        case ">":
                            let molt = 1;
                            if (vel && !raggiunto && (riga.charAt(i+1) == "2" || riga.charAt(i+1) == "3")) {
                                molt = parseInt(riga.charAt(i+1));
                                raggiunto = true;
                            }

                            let piattaformaDx = pagina.add([
                                pagina.sprite("acciaio"),
                                pagina.pos(x, altezza-50-y),
                                pagina.area(),
                                pagina.body( { isStatic: true }),
                                { dir: 1 }
                            ]);
                            piattaformaDx.onUpdate(() => {
                                piattaformaDx.move(200*molt*piattaformaDx.dir, 0);
                                if (piattaformaDx.pos.x <= 0 || piattaformaDx.pos.x >= larghezza-62) piattaformaDx.dir *= -1;
                            })
                            break;

                        case "<":
                            let piattaformaSx = pagina.add([
                                pagina.sprite("acciaio"),
                                pagina.pos(larghezza-62, altezza-50-y),
                                pagina.area(),
                                pagina.body( { isStatic: true }),
                                { dir: -1 }
                            ]);
                            piattaformaSx.onUpdate(() => {
                                piattaformaSx.move(200*piattaformaSx.dir, 0);
                                if (piattaformaSx.pos.x <= 0 || piattaformaSx.pos.x >= larghezza-62) piattaformaSx.dir *= -1;
                            })
                            break;
                        
                        case "@":
                            pagina.add([
                                pagina.sprite("portale"),
                                pagina.pos(x, altezza-50-y),
                                pagina.area(),
                                // pagina.body( { isStatic: true })
                            ]);
                            break;
                    
                        default:
                            break;
                    }

                    x += 64;
                };

                x = 0;
                y += 64;
            });
        }
        generaMappa(mappa);

        const giocatore = pagina.add([
            pagina.sprite("bean"),
            pagina.pos(pagina.center()),
            pagina.area(),
            pagina.body(),
            pagina.health(3),
            "giocatore"
        ]);

        let salto = 0;
        giocatore.onKeyPress(["space", "w"], () => {
            // giocatore.jump(400)
            if (giocatore.isGrounded()) salto = 0;

            if (salto < 2) {
                giocatore.jump(400);
                salto++;
            }
        });

        giocatore.onKeyDown(["d", "right"], () => {
            if (giocatore.isGrounded()) giocatore.move(500, 0);
            else giocatore.move(200, 0);
        });
        giocatore.onKeyDown(["a", "left"], () => {
            if (giocatore.isGrounded()) giocatore.move(-500, 0);
            else giocatore.move(-200, 0);
        })

        giocatore.onCollide("trappola", () => {
            giocatore.hurt(1);
        });

        giocatore.on("hurt", () => {
            if (giocatore.hp() == 2) giocatore.use(sprite("bean2"));
            else if (giocatore.hp() == 1) giocatore.use(sprite("bean3"));
        });
        giocatore.on("death", () => {
            pagina.destroy(giocatore);
            console.log("sei morto");
        })

        giocatore.onKeyPress("q", () => {
            console.log(giocatore.pos);
        })

        giocatore.onUpdate(() => {
            let x, y;
            x = giocatore.pos["x"];
            y = giocatore.pos["y"];

            if (y > 320) y = 320;
            // if (x < 750) x = 750;
            // if (x > 820) x = 820;

            pagina.setCamPos(750, y);
        })
        

    </script>
</body>
</html>